# JBoss AS 5.x/6.x 反序列化漏洞 (CVE-2017-12149)

## 概述 (Overview)

Red Hat JBoss Application Server (JBoss AS) 是一款开源 Java EE 应用服务器。在 JBoss AS 5.x 和 6.x 版本中，其 `HttpInvoker` 组件暴露的 `/invoker/readonly` Servlet 端点存在一个严重的反序列化漏洞。该端点接收 POST 请求的数据，并在未进行充分安全检查的情况下直接进行 Java 反序列化，允许未经身份验证的攻击者发送恶意的序列化对象，从而实现远程代码执行 (RCE)。(通常使用 `vulhub` 等靶场环境进行复现)。

## 漏洞原理 (Vulnerability Principle)

*   **暴露的端点**: JBoss AS 的 `HttpInvoker` 组件是为了支持基于 HTTP 的 RMI 调用而设计的。它在 `/invoker/readonly` URL 路径上监听 POST 请求。
*   **直接反序列化**: 该端点对应的 `ReadOnlyAccessFilter` 过滤器或其他处理代码，直接读取 HTTP POST 请求的 **整个 body** 数据流，并尝试将其作为 Java 序列化对象进行反序列化。
*   **缺少验证**: 在反序列化操作之前，没有对输入数据进行任何有效的类型检查、过滤或验证，也没有限制允许反序列化的类。

这使得攻击者可以构造一个包含恶意代码（通过 gadget chain）的 Java 序列化对象，并将其作为原始字节流直接 POST 到 `/invoker/readonly` 端点。服务器接收到数据后会盲目地进行反序列化，从而触发 gadget chain 并执行攻击者指定的任意代码。

## 利用步骤 (Exploitation Steps)

1.  **生成恶意序列化 Payload**:
    *   使用 `ysoserial` 等 Java 反序列化 payload 生成工具，选择一个目标服务器 Classpath 中存在的 gadget chain（例如 `CommonsCollections` 系列，如果目标依赖了相应库）。
    *   指定要执行的命令（例如下载并执行脚本、反弹 shell 等）。
    *   `java -jar ysoserial.jar <GadgetChain> "your_command_here" > payload.bin`
        *   `<GadgetChain>`: 如 `CommonsCollections5`, `Jdk7u21` 等。
        *   `"your_command_here"`: 要在目标服务器上执行的命令。
        *   `payload.bin`: 输出的包含序列化对象的二进制文件。

2.  **发送 Payload**:
    *   将 `payload.bin` 文件的原始二进制内容作为 POST 请求的 body，发送到目标的 `/invoker/readonly` 端点。
    *   可以使用 `curl` 命令：
        ```bash
        curl http://TARGET_IP:TARGET_PORT/invoker/readonly --data-binary @payload.bin
        ```
        *   `TARGET_IP:TARGET_PORT`: 目标 JBoss 服务器的 IP 地址和端口（默认为 8080）。
        *   `--data-binary @payload.bin`: 指定将 `payload.bin` 文件的原始内容作为 POST body 发送。

3.  **触发执行**:
    *   JBoss 服务器接收到请求后，`/invoker/readonly` 端点的处理逻辑会读取 POST body 并进行反序列化。
    *   反序列化过程触发 `payload.bin` 中嵌入的 gadget chain，最终执行步骤 1 中指定的命令。
    *   如果命令是反弹 shell，确保攻击者机器上有对应的监听器 (`nc -lvp <port>`)。