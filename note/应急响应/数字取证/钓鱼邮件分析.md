#### 概述：电子邮件的结构 (Overview: The Structure of an Email)

一封电子邮件由多个部分组成，主要包括**邮件头 (Header)**、**邮件正文 (Body)**，以及可能的**附件 (Attachments)**。其标准由互联网工程任务组 (IETF) 定义，核心规范包括：

- **RFC 5322**: 规定了电子邮件消息的语法和语义。
    
- **RFC 2045-2049**: 定义了多用途互联网邮件扩展 (MIME) 标准，用于处理附件和非文本内容。
    

在调查可疑邮件时，邮件头是分析的最佳起点，因为它包含了关于邮件来源、路径和真实性的关键元数据。

#### 1. 邮件头分析 (Email Header Analysis)

##### 如何查看邮件头 (How to View Email Headers)

大多数邮件客户端不允许直接查看完整的邮件头。你需要找到类似 **“查看原文 (View Source)”**、**“查看原始邮件 (Show Original)”** 的选项，或者将邮件下载为 `.eml` 文件。`.eml` 文件是纯文本格式，可以使用任何文本编辑器（如记事本、Sublime Text）打开。

##### 常见邮件头字段 (Common Email Header Fields)

- **`Subject`**: 邮件的主题。
    
- **`From`**: 邮件的发送者地址 (**极易被伪造**)。
    
- **`To`**: 邮件的主要接收者地址。
    
- **`Date`**: 邮件发送的日期和时间。
    
- **`Received`**: 记录了邮件从发件人到收件人途中经过的每一个邮件服务器。**这是最值得信赖的字段之一**，用于追踪邮件路径。
    
- **`Reply-To`**: 当收件人回复邮件时，邮件将发送到此地址，而非 `From` 字段的地址。
    
- **`X-Originating-IP`**: 通常记录了邮件发送客户端的原始 IP 地址。
    
- **`Smtp.mailfrom` / `header.from`**: 位于 `Authentication-Results` 头中，记录了用于邮件验证的发送域名。
    

##### 识别邮件来源 (Identifying the Source)

由于 `From` 字段可以被轻易伪造，追踪邮件的真实来源需要依赖 `Received` 字段。邮件的真实来源 IP 地址通常位于**第一个（最底部）的 `Received` 字段**中。找到该 IP 后，你可以使用 IP 查询工具来获取其地理位置、ISP 等信息。

##### 自定义邮件头 (Custom "X-" Headers)

以 `X-` 开头的邮件头属于非标准化的自定义字段，通常由邮件系统添加，用于提供额外信息，例如垃圾邮件评分、内部追踪 ID 等。

#### 2. 邮件附件分析 (Email Attachment Analysis)

##### 文件扩展名欺骗 (File Extension Deception)

攻击者可能会使用替代文件扩展名来绕过安全过滤器。例如，使用 `.htm` 或 `.shtm` 代替 `.html` 来发送恶意网页附件。

##### 内容传输编码 (Content-Transfer-Encoding)

邮件附件（如图片、文档）是二进制数据，无法直接在纯文本的邮件中传输。`Content-Transfer-Encoding` 字段定义了其编码方式，最常见的是 **Base64**。附件的 Base64 编码文本通常出现在 `.eml` 文件的末尾。

#### 3. 混淆技术分析 (Analyzing Obfuscation Techniques)

攻击者常使用混淆技术来隐藏恶意代码，使其难以被人类和安全软件识别。

##### HTML 实体编码混淆 (HTML Entity Encoding Obfuscation)

恶意 HTML 附件中的文本可能看起来像一串随机字符和数字，例如 `<h1>&#80;&#97;&#114;&#114;&#111;&#116;</h1>`。这实际上是 “Parrot” 的 HTML 实体编码。可以使用 **CyberChef** 的 **“From HTML Entity”** 操作进行解码。

##### CSS 压缩与混淆 (CSS Minification & Obfuscation)

攻击者通常会复制知名网站（如微软登录页）的 CSS 样式表，然后对其进行压缩（删除空格、注释）和混淆（重命名选择器），以减小文件大小并逃避基于签名的检测。可以使用 **CleanCSS** 或 **CyberChef** 的 **“CSS Beautify”** 操作来格式化代码，使其变得可读。

##### JavaScript 美化 (JavaScript Beautification)

恶意的 JavaScript 代码通常也被压缩和混淆。可以使用 **Beautifier.io** 或 **CyberChef** 的 **“JavaScript Beautify”** 操作来还原其可读性，以便进行分析。

#### 4. 分析工具箱 (The Analyst's Toolkit)

##### 邮件头分析工具 (Header Analysis Tools)

这些工具可以图形化地展示邮件头的路由路径和延迟信息。

- **Google Messageheader**: [https://toolbox.googleapps.com/apps/messageheader/analyzeheader](https://toolbox.googleapps.com/apps/messageheader/analyzeheader)
    
- **Message Header Analyzer (MHA)**: [https://mha.azurewebsites.net/](https://mha.azurewebsites.net/)
    
- **Mailheader.org**: [https://www.mailheader.org](https://www.google.com/search?q=https://www.mailheader.org)
    

##### IP 与 URL 声誉查询工具 (IP & URL Reputation Tools)

- **IPinfo.io**: [https://ipinfo.io/](https://ipinfo.io/) (查询 IP 地理位置、ISP 等)
    
- **URLScan.io**: [https://urlscan.io/](https://urlscan.io/) (访问 URL 并记录其行为、截图、资源请求等)
    
- **Talos Reputation Center**: [https://talosintelligence.com/reputation](https://talosintelligence.com/reputation) (查询 IP、域名和文件的信誉)
    

##### 附件与正文分析工具 (Attachment & Body Analysis Tools)

- **URL Extractor**: [https://www.convertcsv.com/url-extractor.htm](https://www.convertcsv.com/url-extractor.htm) (从邮件原文中提取所有链接)
    
- **Talos File Reputation**: [https://talosintelligence.com/talos_file_reputation](https://talosintelligence.com/talos_file_reputation) (通过文件哈希查询信誉)
    
- **VirusTotal**: [https://www.virustotal.com/gui/](https://www.virustotal.com/gui/) (通过文件哈希或上传文件进行多引擎扫描)
    

##### 恶意软件沙盒 (Malware Sandboxes)

这些在线服务可以在一个安全隔离的环境中执行可疑文件，并详细报告其行为。

- **Any.Run**: [https://app.any.run/](https://app.any.run/) (提供交互式沙盒分析)
    
- **Hybrid Analysis**: [https://www.hybrid-analysis.com/](https://www.hybrid-analysis.com/)
    
- **Joe Sandbox**: [https://www.joesecurity.org/](https://www.joesecurity.org/)
    

#### 5. 自动化分析平台：PhishTool (Automated Analysis: PhishTool)

PhishTool 是一款强大的钓鱼邮件分析工具，能够自动化许多手动分析步骤。

- **信息提取**: 自动解析 `.eml` 文件，提取发件人、收件人、时间戳、原始 IP、反向 DNS 查询和所有邮件头信息。
    
- **附件与 URL 分析**: 自动提取附件和 URL。通过集成 API 密钥（如 VirusTotal），可以直接在界面中查看文件哈希和信誉评分，无需手动操作。
    
- **OSINT 集成**: 整合威胁情报和开源情报，提供全面的上下文信息。
    
- **案件管理**: 分析师可以对邮件进行标记和备注，便于团队协作和案件追踪。
    

#### 6. 电子邮件安全协议 (Email Security Protocols)

这些协议被设计用来验证发件人身份，防止邮件欺骗和篡改。

##### SPF (发件人策略框架 - Sender Policy Framework)

> **定义**: SPF 是一种 DNS TXT 记录，它列出了被授权为特定域名发送邮件的所有服务器的 IP 地址。接收方邮件服务器可以通过查询该记录来验证邮件来源的合法性。

- **示例记录**: `v=spf1 ip4:127.0.0.1 include:_spf.google.com -all`
    
- **解释**:
    
    - `v=spf1`: 声明为 SPF 版本 1。
        
    - `ip4:127.0.0.1`: 授权此 IP 地址。
        
    - `include:_spf.google.com`: 授权 Google 的邮件服务器。
        
    - `-all`: 拒绝所有其他未明确授权的服务器（硬失败）。
        

##### DKIM (域名密钥识别邮件 - DomainKeys Identified Mail)

> **定义**: DKIM 使用公钥加密技术为邮件添加数字签名。发件人服务器使用私钥对邮件头和正文的关键部分进行签名，并将签名信息添加到邮件头中。接收方服务器通过查询发件人域名的 DNS 来获取公钥，并用其验证签名。

- **优势**: DKIM 签名在邮件转发过程中依然有效，比 SPF 更可靠。
    

##### DMARC (基于域的消息认证、报告和合规性)

> **定义**: DMARC 是建立在 SPF 和 DKIM 之上的策略层。它告诉接收方邮件服务器，当一封声称来自某域名的邮件未能通过 SPF 或 DKIM 检查时，应该如何处理（如`p=quarantine`隔离或`p=reject`拒绝）。此外，DMARC 还能将验证失败的报告发送给域名所有者，帮助其监控和改进邮件安全配置。

- **示例记录**: `v=DMARC1; p=quarantine; rua=mailto:postmaster@website.com`
    

##### S/MIME (安全/多用途互联网邮件扩展)

> **定义**: S/MIME 是一种使用公钥密码学对邮件进行**数字签名**和**端到端加密**的协议。

- **工作流程**:
    
    1. 发件人使用自己的私钥对邮件进行签名，保证了**不可否认性**（证明邮件确实由他发送）。
        
    2. 发件人使用收件人的公钥对邮件进行加密，保证了**机密性**（只有拥有对应私钥的收件人才能阅读）。
        
    3. 双方需要交换包含各自公钥的数字证书才能实现安全通信。