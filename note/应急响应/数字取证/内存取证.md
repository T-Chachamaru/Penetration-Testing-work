#### 概述 (Overview)

**内存取证 (Memory Forensics)** 是计算机取证的一个子集，专注于分析计算机的**易失性内存 (volatile memory)**。在 Windows 操作系统中，这对应于随机存取存储器（RAM）。由于 RAM 的内容在系统重启或关机时会完全清除，因此在事件响应过程中，内存取证通常是需要最先执行的任务之一。

与传统的磁盘取证不同，内存分析不仅能揭示存储在磁盘上的内容，还能提供关于在特定时间点**正在运行的进程或应用程序**的快照，以及系统执行流程的详细信息。这些关键信息可能不会记录在常规的磁盘文件或应用程序日志中。通过内存取证收集的证据对于构建攻击者活动的时间线具有不可估量的价值。

内存取证的核心任务可分为两个主要阶段：

1. **内存获取 (Memory Acquisition)**: 将实时内存的内容完整复制到一个文件（通常称为内存转储文件或 dump）。
    
2. **内存分析 (Memory Analysis)**: 使用专门的工具分析转储文件，提取有价值的取证证据。
    

#### 工具与准备 (Tools and Preparation)

##### 1. 内存获取工具 (Memory Acquisition Tools)

根据目标操作系统的不同，可以使用以下工具来创建内存转储文件：

- **Windows**: FTK Imager, WinPmem
    
- **Linux**: LiME (Linux Memory Extractor)
    
- **macOS**: osxpmem
    

##### 2. 内存分析工具：[[Volatility]] 3

我们将使用 **Volatility 3** 来分析内存转储文件。这是业界公认的标准工具，被广泛应用于事件响应和内存取证分析。

##### 3. 常用 Volatility 3 插件 (Common Volatility 3 Plugins for Windows)

Volatility 3 通过插件系统来解析内存中的特定数据结构。以下是一些针对 Windows 内存分析最常用的插件及其功能摘要：

|插件名称|功能描述|
|---|---|
|`windows.info`|显示内存样本的操作系统、内核版本和硬件详细信息。|
|`windows.pslist`|列出内存映像中的所有活动进程。|
|`windows.pstree`|以树状结构显示进程及其父子关系。|
|`windows.cmdline`|列出每个进程启动时使用的命令行参数。|
|`windows.netscan`|扫描内存中的网络对象（旧版连接）。|
|`windows.netstat`|遍历网络跟踪结构，显示活动的 TCP/UDP 连接和监听端口。|
|`windows.filescan`|扫描内存中存在的文件对象。|
|`windows.mftscan`|扫描 MFT 记录，可用于发现替代数据流（ADS）。|
|`windows.getsids`|打印每个进程所属用户的安全标识符（SID）。|
|`windows.handles`|列出进程打开的句柄（例如文件、注册表键）。|
|`windows.drivermodule`|检查是否有被 Rootkit 隐藏的已加载驱动程序。|

#### 内存分析流程 (Memory Analysis Workflow)

以下流程将使用一个名为 `memdump.mem` 的内存转储文件作为示例。

##### 1. 收集目标信息 (Collecting Target Information)

首先，我们需要确认内存转储文件的基本信息，以确保分析环境的正确性。这有助于我们了解目标的操作系统版本和硬件架构。

- **命令**: 使用 `windows.info` 插件。
    
    Bash
    
    ```
    vol -f memdump.mem windows.info
    ```
    
- **分析**: 输出将显示操作系统版本、处理器数量、架构（如 x64）等信息，这些信息对于验证证据来源和关联其他分析至关重要。
    

##### 2. 搜索可疑活动 (Searching for Suspicious Activity)

网络活动分析

检查是否存在异常的网络连接是识别恶意活动的关键步骤。

- **命令**: 使用 `windows.netstat` 插件。
    
    Bash
    
    ```
    vol -f memdump.mem windows.netstat
    ```
    
- **分析**: 关注任何不寻常的远程连接、连接到已知恶意 IP 的通信，或在非标准端口上建立的连接。
    

进程分析

审查正在运行的进程可以帮助我们发现恶意软件。

- **命令**: 使用 `windows.pstree` 插件以查看进程的父子关系，这有助于识别由合法进程启动的恶意进程。
    
    Bash
    
    ```
    vol -f memdump.mem windows.pstree
    ```
    
- **分析**: 寻找异常的进程名称（例如，拼写错误的合法进程名 `svch0st.exe`），或在不寻常的父进程下运行的进程（例如，`explorer.exe` 启动了 `cmd.exe`，然后启动了 PowerShell）。
    

##### 3. 发现和提取数据 (Discovering and Extracting Data)

扫描内存中的文件对象

我们可以扫描内存以查找攻击者可能已经访问或创建的文件。

- **命令**: 使用 `windows.filescan` 插件。由于输出可能非常庞大，建议将结果重定向到一个文件以便后续分析。
    
    Bash
    
    ```
    vol -f memdump.mem windows.filescan > filescan_out.txt
    ```
    
- **分析**: 之后，可以使用 `cat` 和 `grep` 等命令在输出文件中搜索特定的文件名或扩展名。
    
    Bash
    
    ```
    cat filescan_out.txt | grep "password.txt"
    ```
    

扫描 MFT 记录

为了获取更详细的文件信息（如时间戳），我们可以扫描内存中的 MFT (Master File Table) 记录。

- **命令**: 使用 `windows.mftscan.MFTScan` 插件，同样建议重定向输出。
    
    Bash
    
    ```
    vol -f memdump.mem windows.mftscan.MFTScan > mftscan_out.txt
    ```
    

##### 4. 转储并分析可疑进程 (Dumping and Analyzing a Suspicious Process)

如果发现一个可疑进程（例如，名为 `updater.exe`，PID 为 `1612`），我们可以将其内存空间完整地转储出来进行深度分析。

- **命令**: 使用 `windows.memmap` 插件，并指定进程 PID。
    
    Bash
    
    ```
    # -o . 表示将输出文件保存在当前目录
    vol -f memdump.mem -o . windows.memmap --dump --pid 1612
    ```
    
- **分析**:
    
    1. 上述命令会生成一个以 `.dmp` 为扩展名的文件（例如 `pid.1612.dmp`）。
        
    2. 由于该文件是二进制格式，直接查看很困难。我们可以使用 `strings` 命令来提取其中所有可读的文本字符串。
        
        Bash
        
        ```
        strings pid.1612.dmp > strings_output.txt
        ```
        
    3. 最后，在 `strings_output.txt` 文件中搜索关键词，如 `http`、`key`、IP 地址或任何可能揭示其功能的模式。可以结合 `less` 或 `grep` 进行高效分析。
        
        Bash
        
        ```
        cat strings_output.txt | grep "http"
        cat strings_output.txt | less
        ```

[[Redline]]
